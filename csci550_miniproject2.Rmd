``` r
library(tidyverse)
library(GGally)
library(visdat)
library(janitor)

library(ggfortify) ## PCA Plots

library(glmnet) ## Penalized Regression

house_prices <- read_csv("./cook_county_train_val.csv")

# Drop meaningless variables
house_prices <- select(house_prices, -"...1", -"PIN", -"Description")

house_prices <- house_prices %>% clean_names()

house_prices <- house_prices %>%
  mutate_at(vars(property_class,
                 neighborhood_code,
                 town_code,
                 wall_material,
                 roof_material,
                 basement,
                 basement_finish,
                 central_heating,
                 other_heating,
                 central_air,
                 attic_type,
                 attic_finish,
                 design_plan,
                 cathedral_ceiling,
                 construction_quality,
                 site_desirability,
                 garage_1_material,
                 garage_1_attachment,
                 garage_1_area,
                 garage_2_material,
                 garage_2_attachment,
                 garage_2_area,
                 other_improvements,
                 porch,
                 repair_condition,
                 multi_code,
                 census_tract,
                 multi_property_indicator,
                 modeling_group,
                 use,
                 o_hare_noise,
                 floodplain,
                 road_proximity,
                 pure_market_filter,
                 garage_indicator,
                 neigborhood_code_mapping,
                 town_and_neighborhood,
                 sale_month_of_year),
            factor)

# These columns only have one level per factor, so are not useful for modeling
house_prices <- house_prices %>%
  select(-use, -modeling_group)

# These are duplicates or modifications of other columns
house_prices <- house_prices %>%
  select(-neigborhood_code_mapping, -town_code, -neighborhood_code)

# Documentation says other improvements is not clean enough to be useful
house_prices <- house_prices %>%
  select(-other_improvements)

# Clean sale prices = 1
house_prices <- house_prices %>%
  filter(sale_price > 1)

# Codebook specifies that houses with missing age are set to 10.  Since we can't tell houses with missing age vs houses with true age 10, we decided to drop data points with age == 10.
house_prices <- house_prices %>%
  filter(age != 10)

# land_square_feet and lot_size are the same so we drop one
house_prices <- house_prices %>%
  select(-land_square_feet)

# there are lots of different fields treating date differently, for example sale month of year, sale half year, etc.  To cut down on redundant predictors, we are keeping sale year and sale month of year, as these fields contain the most information
house_prices <- house_prices %>%
  select(-sale_quarter, -sale_half_year, -sale_quarter_of_year, -sale_half_of_year)

# deed number is a unique ID that appears randomly assigned
house_prices <- house_prices %>%
  select(-deed_no)

# age_decade is just age / 10
house_prices <- house_prices %>%
  select(-age_decade)
```


``` r
house_prices %>%
  sample_n(5000) %>%
  vis_miss(warn_large_data = FALSE)

summary(house_prices) %>%
  knitr::kable()

# Levels per factor
sapply(house_prices[sapply(house_prices, is.factor)], nlevels)


baseline <- lm(sale_price ~ building_square_feet, data = house_prices)

summary(baseline)

null_model <- lm(sale_price ~ 1, data = house_prices)
full_model <- lm(sale_price ~ ., data = house_prices)

summary(full_model)


full <- speedglm::speedlm(sale_price ~ . , data = house_prices)

```

# Subset Selection

``` {r subset-selection}
library(MASS)

model.full <- stepAIC(null_model, direction = "forward", scope = sale_price ~ .)

```

# L_1/L_2 Regularized Regression

``` {r ridge-lasso}
input_matrix <- model.matrix(sale_price ~ ., data = house_prices)

lasso <- glmnet(x = input_matrix,
                y = house_prices$sale_price,
                alpha = 1)


plot(lasso)

coef(lasso, s = 0.1)

ridge <- glmnet(x = input_matrix,
                y = house_prices$sale_price,
                alpha = 0)

plot(ridge)

coef(ridge, s = 0.1)
```


# PCA

``` {r pca}
pca <- prcomp(input_matrix)

plot(pca)

autoplot(pca,
         data = house_prices,
         color = "property_class",
         loadings = TRUE,
         loadings.color = "blue",
         loadings.label = TRUE,
         loadings.label.size = 5)

components <- pca[["x"]]

components <- data.frame(components)

components$PC3 <- -components$PC3

components$PC2 <- -components$PC2
```
